services:
  agent:
    build: .
    volumes:
      # Mount the project root to /app
      - ..:/app
      # Mount agent configurations if they exist (optional, docker handles missing source dirs by creating them on host usually, but we want to map existing)
      # We rely on the wrapper script to handle existence or docker compose warning suppression?
      # Actually, let's map precise paths.
      - ${HOME}/.gemini:/home/appuser/.gemini
      - ${HOME}/.config:/home/appuser/.config
      # Mount cursor configuration
      - ${HOME}/.cursor:/home/appuser/.cursor
      # Mount ssh for git cloning
      - ${HOME}/.ssh:/home/appuser/.ssh

      # Mount current workspace
      - ${WORKSPACE_DIR}:/workspace

    command: [ "python3", "/app/combined-autonomous-coding/main.py" ]

    working_dir: /workspace

    ports:
      - "7654:7654"

    # Environment variables can be passed from host
    environment:
      - OPENAI_API_KEY
      - GEMINI_API_KEY
      - PROJECT_NAME
      - PUSHGATEWAY_URL=pushgateway:9091
      - ENABLE_METRICS=true
      # Jira Credentials
      - JIRA_URL
      - JIRA_EMAIL
      - JIRA_TOKEN
      # Git Credentials
      - GIT_TOKEN
      - GIT_USERNAME
      - GIT_HOST
      # Add others as needed

    extra_hosts:
      - "host.docker.internal:host-gateway"

    networks:
      - default
      - monitoring

  ollama:
    profiles:
      - local
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    volumes:
      - ollama_models:/root/.ollama
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

networks:
  monitoring:
    external: true
    name: combined-autonomous-coding_monitoring

volumes:
  ollama_models:
