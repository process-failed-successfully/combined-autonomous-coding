#!/bin/bash

# Resolve the absolute path of the repository root
# We use readlink -f to handle if this script is symlinked (e.g. in /usr/local/bin)
SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
SCRIPT_DIR="$(dirname "$SCRIPT_PATH")"
REPO_ROOT="$(dirname "$SCRIPT_DIR")"
DASHBOARD_URL="http://localhost:7654"

# Check if Dashboard is running via simple curl
if curl --output /dev/null --silent --head --fail "$DASHBOARD_URL/api/dashboard"; then
    echo "âœ… Dashboard is ALREADY running at $DASHBOARD_URL"
    exit 0
fi

echo "ðŸš€ Starting Dashboard at $DASHBOARD_URL..."
echo "Press Ctrl+C to stop."

# Capture the current working directory as the workspace
export WORKSPACE_DIR="$(pwd)"

# Ensure frontend is built
FRONTEND_DIR="$REPO_ROOT/ui/frontend"
if [ ! -f "$FRONTEND_DIR/dist/index.html" ]; then
    echo "ðŸ“¦ Frontend build not found. Building frontend..."
    # Store current dir to return later if needed, though we cd to REPO_ROOT next anyway
    pushd "$FRONTEND_DIR" > /dev/null
    
    if command -v npm >/dev/null 2>&1; then
        echo "Installing dependencies..."
        npm install
        echo "Building frontend..."
        npm run build
    else
        echo "âŒ Error: npm is not installed. Cannot build frontend."
        echo "Please install nodejs and npm to run the dashboard."
        exit 1
    fi
    
    popd > /dev/null
    echo "âœ… Frontend built successfully."
fi

# Run from Repo Root
cd "$REPO_ROOT"
./safe_run.sh "$@" --dashboard-only --dashboard-url "$DASHBOARD_URL"
